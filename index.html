<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>京西福地 · 五福临门 — 拍照</title>
  <style>
    body{ margin:0; font-family: -apple-system, BlinkMacSystemFont, "Noto Sans SC", "PingFang SC", "Microsoft YaHei", sans-serif; background:#fff7f0; color:#222; }
    .container{ max-width:540px; margin:0 auto; padding:12px; }
    header{ text-align:center; padding:12px 0; background:linear-gradient(90deg,#c91018,#ff6b6b); color:#fff; border-radius:8px; }
    header h1{ margin:0; font-size:18px; }
    .preview{ margin-top:12px; position:relative; border-radius:12px; overflow:hidden; background:#000; }
    video{ width:100%; height:auto; display:block; object-fit:cover; }
    canvas{ display:none; }
    .overlay{ position:absolute; left:0; right:0; top:0; bottom:0; pointer-events:none; display:flex; flex-direction:column; justify-content:space-between; }
    .top{ padding:10px; display:flex; justify-content:center; align-items:center; }
    .title{ background:rgba(255,255,255,0.06); padding:6px 12px; border-radius:18px; color:#ffd66b; font-weight:800; }
    .centerText{ text-align:center; color:#c91018; font-weight:900; text-shadow:0 6px 10px rgba(0,0,0,0.3); }
    .controls{ display:flex; gap:8px; justify-content:center; margin-top:12px; }
    button{ padding:10px 14px; border-radius:10px; border:none; font-weight:700; }
    .primary{ background:#c91018; color:#fff; }
    .secondary{ background:#fff; color:#c91018; border:1px solid #f0dcdc; }
    .hint{ margin-top:10px; font-size:13px; color:#666; text-align:center; }
    .fallback{ margin-top:10px; padding:8px; background:#fff4f4; border-radius:8px; color:#7a1a1a; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>京西福地 · 五福临门</h1>
    </header>

    <div class="preview" id="previewWrap">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas"></canvas>

      <div class="overlay" aria-hidden="true">
        <div class="top"><div class="title">京西福地 五福临门</div></div>
        <div style="padding:12px; text-align:center;">
          <div class="centerText" style="font-size:28px;">马年大吉</div>
        </div>
      </div>
    </div>

    <div class="controls" role="group" aria-label="controls">
      <button id="flip" class="secondary">切换前后</button>
      <button id="shutter" class="primary">拍 照</button>
      <button id="save" class="secondary">保存</button>
    </div>

    <div class="hint">请在手机浏览器中打开并允许摄像头权限。若在微信内置浏览器无法打开摄像头，请使用系统浏览器（Safari/Chrome）打开。</div>

    <div id="fallback" class="fallback" style="display:none;">
      当前浏览器无法直接访问相机。你可以使用下面的文件输入拍照或选择已有图片：
      <div style="margin-top:8px;"><input id="fileInput" type="file" accept="image/*;capture=camera" capture="environment"></div>
    </div>
  </div>

  <script>
    (function(){
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const shutter = document.getElementById('shutter');
      const saveBtn = document.getElementById('save');
      const flipBtn = document.getElementById('flip');
      const fallback = document.getElementById('fallback');
      const fileInput = document.getElementById('fileInput');

      let stream = null;
      let usingFront = false; // false = back, true = front

      async function startCamera(){
        if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
          fallback.style.display = 'block';
          return;
        }
        const constraints = { video: { facingMode: usingFront ? 'user' : 'environment' }, audio:false };
        try{
          stream = await navigator.mediaDevices.getUserMedia(constraints);
        }catch(e){
          // try looser constraint
          try{
            stream = await navigator.mediaDevices.getUserMedia({ video: true, audio:false });
          }catch(err){
            console.warn('getUserMedia failed', err);
            fallback.style.display = 'block';
            return;
          }
        }
        video.srcObject = stream;
        video.play().catch(()=>{});
        // ensure canvas size matches video when metadata loaded
        video.addEventListener('loadedmetadata', ()=>{
          resizeCanvas();
        });
      }

      function stopCamera(){
        if(stream){
          stream.getTracks().forEach(t=>t.stop());
          stream = null;
        }
      }

      function resizeCanvas(){
        const vw = video.videoWidth || video.clientWidth;
        const vh = video.videoHeight || video.clientHeight;
        canvas.width = vw;
        canvas.height = vh;
        // scale canvas CSS to match container
        canvas.style.width = video.clientWidth + 'px';
        canvas.style.height = video.clientHeight + 'px';
      }

      async function takePhoto(){
        if(!stream){
          alert('相机未就绪或权限被禁止');
          return null;
        }
        const vw = video.videoWidth;
        const vh = video.videoHeight;
        if(!vw || !vh){
          alert('视频未就绪，请稍候');
          return null;
        }
        canvas.width = vw; canvas.height = vh;
        const ctx = canvas.getContext('2d');
        // draw current frame
        ctx.drawImage(video, 0, 0, vw, vh);

        // overlay text decorations
        ctx.save();
        const pad = Math.round(Math.min(vw,vh) * 0.02);
        // bottom text
        ctx.font = Math.floor(vw/14) + 'px "Noto Sans SC"';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        ctx.lineWidth = Math.max(6, Math.round(vw*0.006));
        ctx.strokeStyle = 'rgba(80,40,10,0.9)';
        ctx.strokeText('京西福地  五福临门', vw/2, vh - pad - 20);
        ctx.fillStyle = '#ffd66b';
        ctx.fillText('京西福地  五福临门', vw/2, vh - pad - 20);
        // big text
        const big = '马年大吉';
        ctx.font = Math.floor(vw/9) + 'px "Noto Sans SC"';
        ctx.textBaseline = 'middle';
        ctx.strokeStyle = 'rgba(0,0,0,0.35)';
        ctx.lineWidth = Math.max(8, Math.round(vw*0.01));
        ctx.strokeText(big, vw/2, vh*0.68);
        ctx.fillStyle = '#c91018';
        ctx.fillText(big, vw/2, vh*0.68);
        ctx.restore();

        return canvas.toDataURL('image/jpeg', 0.95);
      }

      shutter.addEventListener('click', async ()=>{
        shutter.disabled = true;
        const dataUrl = await takePhoto();
        if(dataUrl){
          // show quick preview by opening in new tab or downloading
          // we'll open in new tab for preview; user can save from there
          const w = window.open();
          if(w){
            w.document.write('<title>预览</title>');
            w.document.write('<img src="' + dataUrl + '" style="max-width:100%">');
          }else{
            // fallback: download
            const a = document.createElement('a');
            a.href = dataUrl; a.download = 'jingxi-fudi-' + Date.now() + '.jpg';
            document.body.appendChild(a); a.click(); a.remove();
          }
        }
        shutter.disabled = false;
      });

      saveBtn.addEventListener('click', async ()=>{
        const dataUrl = await takePhoto();
        if(dataUrl){
          const a = document.createElement('a');
          a.href = dataUrl; a.download = 'jingxi-fudi-' + Date.now() + '.jpg';
          document.body.appendChild(a); a.click(); a.remove();
        }
      });

      flipBtn.addEventListener('click', async ()=>{
        usingFront = !usingFront;
        stopCamera();
        await startCamera();
      });

      // file input fallback
      fileInput.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        const url = URL.createObjectURL(f);
        const img = new Image();
        img.onload = ()=>{
          canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img,0,0);
          // draw overlays
          ctx.save();
          ctx.font = Math.floor(canvas.width/14) + 'px "Noto Sans SC"';
          ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';
          ctx.lineWidth = Math.max(6, Math.round(canvas.width*0.006));
          ctx.strokeStyle = 'rgba(80,40,10,0.9)';
          ctx.strokeText('京西福地  五福临门', canvas.width/2, canvas.height - 40);
          ctx.fillStyle = '#ffd66b';
          ctx.fillText('京西福地  五福临门', canvas.width/2, canvas.height - 40);
          ctx.restore();
          // open preview
          const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
          const w = window.open(); if(w){ w.document.write('<img src="'+dataUrl+'" style="max-width:100%">'); }
          URL.revokeObjectURL(url);
        };
        img.src = url;
      });

      // start on load
      startCamera();
      // cleanup
      window.addEventListener('pagehide', ()=> stopCamera());
    })();
  </script>
</body>
</html>
